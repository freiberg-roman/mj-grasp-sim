from mgs.sampler.kin.base import KinematicsModel
from flax import nnx
import jax
import jax.numpy as jnp


class LeapHandKinematicsModel(nnx.Module, KinematicsModel):
    def __init__(self, lmax=2, num_emb_channels=64):
        self.lmax = lmax
        self.num_channels = num_emb_channels
        self.num_dofs = 16
        self.num_extra_dofs = 0
        self.embedding = nnx.Param(
            jax.random.normal(
                nnx.Rngs(0)(),
                shape=(self.num_dofs, (lmax + 1) ** 2, num_emb_channels),
            )
        )
        self.kinematics_graph = [
            [0, 1, 2, 3],  # index finger
            [4, 5, 6, 7],  # middle finger
            [8, 9, 10, 11],  # ring finger
            [12, 13, 14, 15],  # thumb finger
        ]
        self.base_to_contact = nnx.Variable(
            jnp.array([1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0])
        )

        self.kinematics_transforms = nnx.Variable(
            jnp.array(
                [
                    # index finger
                    [0.500003, 0.5, 0.5, -0.499997, -0.007, 0.023, -0.0187],
                    [0.500003, -0.5, -0.499997, 0.5, -0.0122, 0.0381, 0.0145],
                    [0.500003, 0.5, -0.5, 0.499997, 0.015, 0.0143, -0.013],
                    [1, 0, 0, 0, 0, -0.0361, 0.0002],
                    # middle finger
                    [0.500003, 0.5, 0.5, -0.499997, -0.0071, -0.0224, -0.0187],
                    [0.500003, -0.5, -0.499997, 0.5, -0.0122, 0.0381, 0.0145],
                    [0.500003, 0.5, -0.5, 0.499997, 0.015, 0.0143, -0.013],
                    [1, 0, 0, 0, 0, -0.0361, 0.0002],
                    # ring finger
                    [0.500003, 0.5, 0.5, -0.499997, -0.00709, -0.0678, -0.0187],
                    [0.500003, -0.5, -0.499997, 0.5, -0.0122, 0.0381, 0.0145],
                    [0.500003, 0.5, -0.5, 0.499997, 0.015, 0.0143, -0.013],
                    [1.0, 0, 0, 0, 0, -0.03609, 0.0002],
                    # thumb
                    [0.707109, 0, 0.707105, 0, -0.0693, -0.0012, -0.0216],
                    [0.500003, 0.5, -0.5, 0.499997, 0, 0.0143, -0.013],
                    [0.707109, -0.707105, 0, 0, 0, 0.0145, -0.017],
                    [0, 0, 0, 1, 0, 0.0466, 0.0002],
                ]
            )
        )
        self.keypoint_offset = nnx.Variable(
            jnp.array(
                [
                    # index finger
                    [0.0, 0.0, 0.0],
                    [0.0, 0.0, 0.0],
                    [0.0, 0.0, 0.0],
                    [0.0, 0.0, 0.0],
                    # middle finger
                    [0.0, 0.0, 0.0],
                    [0.0, 0.0, 0.0],
                    [0.0, 0.0, 0.0],
                    [0.0, 0.0, 0.0],
                    # ring finger
                    [0.0, 0.0, 0.0],
                    [0.0, 0.0, 0.0],
                    [0.0, 0.0, 0.0],
                    [0.0, 0.0, 0.0],
                    # thumb
                    [0.0, 0.0, 0.0],
                    [0.0, 0.0, 0.0],
                    [0.0, 0.0, 0.0],
                    [0.0, 0.0, 0.0],
                ]
            )
        )
        # a six-dimensional vector with a translational direction and rotation axis
        self.joint_transforms = nnx.Variable(
            jnp.array(
                [
                    [0, 0, 0, 0, 0, -1],
                    [0, 0, 0, 0, 0, -1],
                    [0, 0, 0, 0, 0, -1],
                    [0, 0, 0, 0, 0, -1],
                    [0, 0, 0, 0, 0, -1],
                    [0, 0, 0, 0, 0, -1],
                    [0, 0, 0, 0, 0, -1],
                    [0, 0, 0, 0, 0, -1],
                    [0, 0, 0, 0, 0, -1],
                    [0, 0, 0, 0, 0, -1],
                    [0, 0, 0, 0, 0, -1],
                    [0, 0, 0, 0, 0, -1],
                    [0, 0, 0, 0, 0, -1],
                    [0, 0, 0, 0, 0, -1],
                    [0, 0, 0, 0, 0, -1],
                    [0, 0, 0, 0, 0, -1],
                ],
                dtype=jnp.float32,
            )
        )
        # note these ranges are fo the leap hand in dex
        # MuJoCo ranges differ for the thumb
        self.joint_ranges = nnx.Variable(
            jnp.array(
                [
                    [-0.314, 2.23],  # mcp
                    [-1.047, 1.047],  # rot
                    [-0.506, 1.885],  # pip
                    [-0.366, 2.042],  # dip
                    [-0.314, 2.23],
                    [-1.047, 1.047],
                    [-0.506, 1.885],
                    [-0.366, 2.042],
                    [-0.314, 2.23],
                    [-1.047, 1.047],
                    [-0.506, 1.885],
                    [-0.366, 2.042],
                    # thumb
                    [-0.349, 2.094],
                    [-0.47, 2.443],
                    [-1.2, 1.9],
                    [-1.34, 1.88],
                ]
            )
        )

        self.fingertip_normals = nnx.Variable(
            jnp.array(
                [
                    [1.0, 0, 0],
                    [1.0, 0, 0],
                    [1.0, 0, 0],
                    [1.0, 0, 0],
                ]
            )
        )
        self.fingertip_idx = nnx.Variable(jnp.array([3, 7, 11, 15], dtype=jnp.int32))
        self.local_fingertip_contact_positions = nnx.Variable(
            jnp.array(
                [
                    [
                        [
                            -0.012098115891466496,
                            -0.02540615038654199,
                            0.0183999999999995,
                        ],
                        [
                            -0.012098115891466496,
                            -0.02540615038654199,
                            0.0144999999999995,
                        ],
                        [
                            -0.012098115891466496,
                            -0.02540615038654199,
                            0.010599999999999499,
                        ],
                        [
                            -0.012098115891466496,
                            -0.03011124688654199,
                            0.0183999999999995,
                        ],
                        [
                            -0.012098115891466496,
                            -0.030111246886541994,
                            0.014499999999999501,
                        ],
                        [
                            -0.012098115891466496,
                            -0.030111246886541994,
                            0.010599999999999499,
                        ],
                        [
                            -0.012098115891466496,
                            -0.03481634338654199,
                            0.018399999999999504,
                        ],
                        [
                            -0.012098115891466496,
                            -0.03481634338654199,
                            0.014499999999999501,
                        ],
                        [
                            -0.012098115891466496,
                            -0.03481634338654199,
                            0.0105999999999995,
                        ],
                        [
                            -0.012098115891466496,
                            -0.03952143988654199,
                            0.018399999999999504,
                        ],
                        [
                            -0.012098115891466496,
                            -0.03952143988654199,
                            0.014499999999999501,
                        ],
                        [
                            -0.012098115891466496,
                            -0.03952143988654199,
                            0.0105999999999995,
                        ],
                        [
                            -0.012098115891466496,
                            -0.044226536386542,
                            0.018399999999999504,
                        ],
                        [
                            -0.012098115891466496,
                            -0.044226536386542,
                            0.014499999999999503,
                        ],
                        [
                            -0.012098115891466496,
                            -0.044226536386542,
                            0.010599999999999502,
                        ],
                    ],
                    [
                        [
                            -0.012098115891466496,
                            -0.02540615038654199,
                            0.0183999999999995,
                        ],
                        [
                            -0.012098115891466496,
                            -0.02540615038654199,
                            0.0144999999999995,
                        ],
                        [
                            -0.012098115891466496,
                            -0.02540615038654199,
                            0.010599999999999499,
                        ],
                        [
                            -0.012098115891466496,
                            -0.03011124688654199,
                            0.0183999999999995,
                        ],
                        [
                            -0.012098115891466496,
                            -0.030111246886541994,
                            0.014499999999999501,
                        ],
                        [
                            -0.012098115891466496,
                            -0.030111246886541994,
                            0.010599999999999499,
                        ],
                        [
                            -0.012098115891466496,
                            -0.03481634338654199,
                            0.018399999999999504,
                        ],
                        [
                            -0.012098115891466496,
                            -0.03481634338654199,
                            0.014499999999999501,
                        ],
                        [
                            -0.012098115891466496,
                            -0.03481634338654199,
                            0.0105999999999995,
                        ],
                        [
                            -0.012098115891466496,
                            -0.03952143988654199,
                            0.018399999999999504,
                        ],
                        [
                            -0.012098115891466496,
                            -0.03952143988654199,
                            0.014499999999999501,
                        ],
                        [
                            -0.012098115891466496,
                            -0.03952143988654199,
                            0.0105999999999995,
                        ],
                        [
                            -0.012098115891466496,
                            -0.044226536386542,
                            0.018399999999999504,
                        ],
                        [
                            -0.012098115891466496,
                            -0.044226536386542,
                            0.014499999999999503,
                        ],
                        [
                            -0.012098115891466496,
                            -0.044226536386542,
                            0.010599999999999502,
                        ],
                    ],
                    [
                        [
                            -0.012098115891466496,
                            -0.02540615038654199,
                            0.0183999999999995,
                        ],
                        [
                            -0.012098115891466496,
                            -0.02540615038654199,
                            0.0144999999999995,
                        ],
                        [
                            -0.012098115891466496,
                            -0.02540615038654199,
                            0.010599999999999499,
                        ],
                        [
                            -0.012098115891466496,
                            -0.03011124688654199,
                            0.0183999999999995,
                        ],
                        [
                            -0.012098115891466496,
                            -0.030111246886541994,
                            0.014499999999999501,
                        ],
                        [
                            -0.012098115891466496,
                            -0.030111246886541994,
                            0.010599999999999499,
                        ],
                        [
                            -0.012098115891466496,
                            -0.03481634338654199,
                            0.018399999999999504,
                        ],
                        [
                            -0.012098115891466496,
                            -0.03481634338654199,
                            0.014499999999999501,
                        ],
                        [
                            -0.012098115891466496,
                            -0.03481634338654199,
                            0.0105999999999995,
                        ],
                        [
                            -0.012098115891466496,
                            -0.03952143988654199,
                            0.018399999999999504,
                        ],
                        [
                            -0.012098115891466496,
                            -0.03952143988654199,
                            0.014499999999999501,
                        ],
                        [
                            -0.012098115891466496,
                            -0.03952143988654199,
                            0.0105999999999995,
                        ],
                        [
                            -0.012098115891466496,
                            -0.044226536386542,
                            0.018399999999999504,
                        ],
                        [
                            -0.012098115891466496,
                            -0.044226536386542,
                            0.014499999999999503,
                        ],
                        [
                            -0.012098115891466496,
                            -0.044226536386542,
                            0.010599999999999502,
                        ],
                    ],
                    [
                        [
                            -0.012098111537332616,
                            -0.05630000508860301,
                            -0.018200004692667797,
                        ],
                        [
                            -0.012098111537332618,
                            -0.05630000508860301,
                            -0.014300003192667794,
                        ],
                        [
                            -0.01209811153733262,
                            -0.05630000508860301,
                            -0.010400001692667794,
                        ],
                        [
                            -0.012098111537332616,
                            -0.05120000358860301,
                            -0.018200004692667797,
                        ],
                        [
                            -0.012098111537332618,
                            -0.05120000358860301,
                            -0.014300003192667794,
                        ],
                        [
                            -0.01209811153733262,
                            -0.05120000358860301,
                            -0.010400001692667794,
                        ],
                        [
                            -0.012098111537332616,
                            -0.046100002088603015,
                            -0.018200004692667797,
                        ],
                        [
                            -0.012098111537332618,
                            -0.046100002088603015,
                            -0.014300003192667794,
                        ],
                        [
                            -0.01209811153733262,
                            -0.046100002088603015,
                            -0.010400001692667794,
                        ],
                        [
                            -0.012098111537332616,
                            -0.041000000588603015,
                            -0.018200004692667797,
                        ],
                        [
                            -0.012098111537332618,
                            -0.041000000588603015,
                            -0.014300003192667794,
                        ],
                        [
                            -0.01209811153733262,
                            -0.041000000588603015,
                            -0.010400001692667794,
                        ],
                        [
                            -0.012098111537332616,
                            -0.035899999088603016,
                            -0.018200004692667797,
                        ],
                        [
                            -0.012098111537332618,
                            -0.035899999088603016,
                            -0.014300003192667794,
                        ],
                        [
                            -0.01209811153733262,
                            -0.035899999088603016,
                            -0.010400001692667794,
                        ],
                    ],
                ]
            )
        )
        self.init_pregrasp_joint = nnx.Variable(
            jnp.array(
                [
                    1.57 / 2.0,
                    0.0,
                    0.0,
                    0.0,
                    1.57 / 2.0,
                    0.0,
                    0.0,
                    0.0,
                    1.57 / 2.0,
                    0.0,
                    0.0,
                    0.0,
                    1.57 / 2.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                dtype=jnp.float32,
            )
        )
